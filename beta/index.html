<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <meta name="author" content="Ivan Montibeller">
    <meta name="description" content="ESF Thamara Katryne Rodrigues Schmidt - Unidade de Sa√∫de da Fam√≠lia em Blumenau - SC">
    <meta name="keywords" content="ESF, Sa√∫de da Fam√≠lia, Blumenau, SC, Unidade de Sa√∫de, Thamara Katryne Rodrigues Schmidt, Atendimento M√©dico, Sa√∫de Comunit√°ria">
    <title>Assistente Virtual ‚Äì ESF Thamara</title>
<link rel="stylesheet" href="./css/xp-responsive.css"></head>
    <style>
        /* Estilos espec√≠ficos do Chat Profissional */
        .chat-wrapper { display: flex; flex-direction: column; height: 100%; }
        .chat-history { flex: 1; overflow-y: auto; padding: 20px; background: #fff; display: flex; flex-direction: column; gap: 12px; scroll-behavior: smooth; }
        .message { max-width: 85%; padding: 12px 16px; border-radius: 18px; font-size: 15px; line-height: 1.5; position: relative; animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
        .message.bot { align-self: flex-start; background: #f0f2f5; color: #1c1e21; border-bottom-left-radius: 4px; border: 1px solid #e4e6eb; }
        .message.user { align-self: flex-end; background: #0084ff; color: white; border-bottom-right-radius: 4px; }
        .chat-controls { padding: 15px; background: #f0f0f0; border-top: 1px solid #dcdcdc; display: flex; gap: 10px; align-items: center; }
        .chat-input { flex: 1; padding: 12px; border: 1px solid #ccc; border-radius: 24px; outline: none; font-size: 15px; transition: border-color 0.2s; }
        .chat-input:focus { border-color: #0084ff; box-shadow: 0 0 0 2px rgba(0,132,255,0.2); }
        .send-btn { background: #0084ff; color: white; border: none; padding: 10px 24px; border-radius: 24px; cursor: pointer; font-weight: 600; transition: background 0.2s; }
        .send-btn:hover { background: #0073e6; }
        .typing { font-size: 12px; color: #65676b; margin-left: 20px; margin-bottom: 5px; display: none; font-style: italic; }
        @keyframes popIn { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }
        /* Estilo para Bot√µes de Op√ß√£o */
        .options-container { display: flex; flex-wrap: wrap; gap: 8px; margin: 8px 0 16px 20px; animation: popIn 0.3s ease; }
        .option-btn { background: #fff; border: 1px solid #0084ff; color: #0084ff; padding: 8px 16px; border-radius: 20px; cursor: pointer; font-size: 14px; transition: all 0.2s; font-family: inherit; }
        .option-btn:hover { background: #0084ff; color: #fff; transform: translateY(-1px); box-shadow: 0 2px 4px rgba(0,132,255,0.2); }
    </style>
    <style>
        /* Estilos para o Feedback */
        .feedback-container { display: flex; gap: 8px; margin: 12px 0 5px 20px; align-items: center; animation: popIn 0.4s ease; }
        .feedback-container span { font-size: 13px; color: #65676b; font-style: italic; }
        .feedback-btn { background: #f0f2f5; border: 1px solid #dcdcdc; border-radius: 50%; width: 34px; height: 34px; cursor: pointer; font-size: 16px; transition: all 0.2s; display: flex; align-items: center; justify-content: center; }
        .feedback-btn:hover:not(:disabled) { background: #e4e6eb; transform: scale(1.1); }
        .feedback-btn:disabled { cursor: not-allowed; filter: grayscale(80%); opacity: 0.7; }
    </style>


<body> 
  <!-- Barra de menus -->
  <div>
  <nav style="background:#0b5fa5; color:#fff; padding:10px; display:flex; justify-content:center; gap:20px; font-weight:bold;">
    <a href="/index.html" style="color:#fff; text-decoration:none;">üè† In√≠cio</a>
    <a href="./blog/agenda.html" style="color:#fff; text-decoration:none;">‚ÑπÔ∏è Agenda</a>
    <a href="./equipe.html" style="color:#fff; text-decoration:none;">üë©‚Äç‚öïÔ∏è Nossa Equipe</a>
  </nav>
    </div>

<!-- CHATBOT INTERFACE -->
<div class="xp-window" style="max-width: 800px; margin: 20px auto; height: 70vh; display: flex; flex-direction: column;">
    <div class="xp-titlebar">ü§ñ Assistente Virtual ‚Äî ESF Thamara</div>
    <div class="xp-content" style="flex: 1; padding: 0; overflow: hidden;">
        
        <div class="chat-wrapper">
            <div id="chatHistory" class="chat-history">
                <!-- Mensagem inicial -->
                <div class="message bot">
                    Ol√°! Sou a Intelig√™ncia Artificial da ESF Thamara. üè•<br>
                    Posso ajudar com hor√°rios, endere√ßo, vacinas ou d√∫vidas sobre a unidade.<br>
                    <strong>Como posso ajudar voc√™ hoje?</strong>
                </div>
            </div>
            
            <div id="typingIndicator" class="typing">Digitando...</div>
            
            <div class="chat-controls">
                <input type="text" id="userInput" class="chat-input" placeholder="Digite sua d√∫vida aqui..." autocomplete="off" aria-label="Digite sua d√∫vida">
                <button id="sendBtn" class="send-btn" aria-label="Enviar mensagem">Enviar</button>
            </div>
        </div>

    </div>
</div>

<script type="module">
    // --- L√ìGICA DO CHATBOT COM IA (Transformers.js) ---
    import { pipeline, env } from 'https://cdn.jsdelivr.net/npm/@xenova/transformers@2.6.0';
    
    // Configura√ß√£o para rodar no navegador sem buscar modelos locais
    env.allowLocalModels = false;
    
    const chatHistory = document.getElementById('chatHistory');
    const userInput = document.getElementById('userInput');
    const sendBtn = document.getElementById('sendBtn');
    const typingIndicator = document.getElementById('typingIndicator');

    let knowledgeBase = [];
    let extractor = null;
    let lastBotContext = ""; // Mem√≥ria de curto prazo para contexto

    // Inicializa√ß√£o
    async function initAI() {
        try {
            // 1. Carregar base de conhecimento do Backend (unificado com o DB)
            const resp = await fetch('api/get-interactions.php'); // << UNIFICA√á√ÉO
            knowledgeBase = await resp.json();

            // 2. Carregar Modelo de IA (Multil√≠ngue para melhor precis√£o em PT-BR)
            addMessage("<i>üîÑ Inicializando motor neural (Multil√≠ngue)... isso pode levar alguns segundos.</i>", 'bot');
            userInput.disabled = true;
            
            // Upgrade: Modelo Multil√≠ngue + Quantizado para performance
            extractor = await pipeline('feature-extraction', 'Xenova/paraphrase-multilingual-MiniLM-L12-v2');
            
            // 3. Pr√©-calcular embeddings (vetores) das perguntas conhecidas
            // Otimiza√ß√£o: Processamento em lote (Batch) para inicializa√ß√£o mais r√°pida
            for (let item of knowledgeBase) {
                if (item.keys && item.keys.length > 0) {
                    const output = await extractor(item.keys, { pooling: 'mean', normalize: true });
                    
                    // O output.data √© um Float32Array plano. Precisamos fatiar pelos dims.
                    const embeddingSize = output.dims[output.dims.length - 1];
                    const batchSize = item.keys.length;
                    item.embeddings = [];

                    for (let i = 0; i < batchSize; i++) {
                        const start = i * embeddingSize;
                        const end = start + embeddingSize;
                        item.embeddings.push(output.data.slice(start, end));
                    }
                }
            }

            // Pronto
            const loadingMsg = chatHistory.querySelector('.bot:last-child');
            if(loadingMsg && loadingMsg.innerHTML.includes('Inicializando')) loadingMsg.remove();
            
            addMessage("IA Pronta (Motor v3.0 - DB Powered)! üß† Teste: 'Estou com dor de barriga'", 'bot');
            userInput.disabled = false;
            userInput.focus();

        } catch (e) {
            console.error(e);
            addMessage("‚ùå Erro ao conectar com o motor da IA. O servi√ßo de backend pode estar offline. Verifique o console para mais detalhes.", 'bot');
        }
    }

    // Fun√ß√£o matem√°tica para comparar similaridade (Cosseno)
    function cosineSimilarity(a, b) {
        let dot = 0, normA = 0, normB = 0;
        for (let i = 0; i < a.length; i++) {
            dot += a[i] * b[i];
            normA += a[i] * a[i];
            normB += b[i] * b[i];
        }
        return dot / (Math.sqrt(normA) * Math.sqrt(normB));
    }

    // Fun√ß√£o auxiliar para buscar matches
    function getMatches(embedding) {
        let matches = [];
        for (let item of knowledgeBase) {
            let maxScore = -1;
            if(item.embeddings) {
                for (let keyEmb of item.embeddings) {
                    const score = cosineSimilarity(embedding, keyEmb);
                    if (score > maxScore) maxScore = score;
                }
            }
            matches.push({ item: item, score: maxScore });
        }
        return matches.sort((a, b) => b.score - a.score);
    }

    async function findResponse(text) {
        if (!extractor) return { text: "A IA ainda est√° carregando..." };
        
        // 1. An√°lise Direta (Input do usu√°rio)
        const output = await extractor(text, { pooling: 'mean', normalize: true });
        const userEmbedding = output.data;
        let results = getMatches(userEmbedding);
        let contextUsed = false;

        // 2. An√°lise Contextual (Se o score for baixo ou texto curto, tenta combinar com a √∫ltima fala do bot)
        // Ex: Bot disse "Onde √© a dor?" e user disse "Barriga". Contexto ajuda a diferenciar de apenas "Barriga".
        if (lastBotContext && (text.length < 50 || results[0].score < 0.60)) {
            const contextQuery = lastBotContext + " " + text;
            const contextOutput = await extractor(contextQuery, { pooling: 'mean', normalize: true });
            const contextResults = getMatches(contextOutput.data);

            // Se o contexto melhorou significativamente a confian√ßa (> 5%), usamos o resultado contextual
            if (contextResults[0].score > results[0].score + 0.05) {
                console.log("Contexto utilizado:", contextQuery);
                results = contextResults;
                contextUsed = true;
            }
        }
        
        const bestMatch = results[0];
        const bestScore = bestMatch.score;
        const responseData = {
            text: "Desculpe, n√£o tenho certeza sobre isso. Tente ser mais espec√≠fico sobre onde √© a dor ou o que precisa.",
            options: [],
            intentId: 'fallback',
            score: bestScore,
            contextUsed: contextUsed
        };

        // Se a confian√ßa for muito baixa (< 0.40), assume que n√£o entendeu
        // Ajustado para 0.40 pois o modelo multil√≠ngue √© mais preciso
        if (bestScore < 0.40) return responseData;
        
        // 3. Detec√ß√£o de M√∫ltiplas Vari√°veis (Ex: "Dor de cabe√ßa e febre")
        // Se o segundo melhor resultado tamb√©m for muito bom e pr√≥ximo do primeiro
        const secondMatch = results[1];
        if (secondMatch && secondMatch.score > 0.50 && (bestScore - secondMatch.score) < 0.08) {
            // Evita duplicar se for o mesmo ID ou muito similar
            if (bestMatch.item.id !== secondMatch.item.id) {
                responseData.text = `Entendi que voc√™ pode estar com mais de um sintoma. Veja:<br><br>1Ô∏è‚É£ ${bestMatch.item.resp}<br><hr style='margin:10px 0; opacity:0.3'>2Ô∏è‚É£ ${secondMatch.item.resp}`;
                responseData.options = [...(bestMatch.item.options || []), ...(secondMatch.item.options || [])].slice(0, 4);
                responseData.intentId = `${bestMatch.item.id}+${secondMatch.item.id}`;
                return responseData;
            }
        }

        // Resposta padr√£o com melhor match
        responseData.text = bestMatch.item.resp;
        responseData.options = bestMatch.item.options;
        responseData.intentId = bestMatch.item.id;

        return responseData;
    }

    function addMessage(text, sender) {
        const div = document.createElement('div');
        div.className = `message ${sender}`;
        div.innerHTML = text;
        chatHistory.appendChild(div);
        chatHistory.scrollTop = chatHistory.scrollHeight;
    }

    function addOptions(options) {
        const div = document.createElement('div');
        div.className = 'options-container';
        options.forEach(opt => {
            const btn = document.createElement('button');
            btn.className = 'option-btn';
            btn.innerText = opt;
            btn.onclick = () => {
                userInput.value = opt; // Preenche o input
                handleUserMessage();   // Envia como se o usu√°rio tivesse digitado
            };
            div.appendChild(btn);
        });
        chatHistory.appendChild(div);
        chatHistory.scrollTop = chatHistory.scrollHeight;
    }

    function addFeedbackControls(userQuery, responsePayload) {
        const container = document.createElement('div');
        container.className = 'feedback-container';

        const label = document.createElement('span');
        label.innerText = 'A resposta foi √∫til?';
        container.appendChild(label);

        const feedbacks = [
            { emoji: 'üëç', value: 'positive' },
            { emoji: 'üòê', value: 'neutral' },
            { emoji: 'üëé', value: 'negative' }
        ];

        feedbacks.forEach(fb => {
            const btn = document.createElement('button');
            btn.className = 'feedback-btn';
            btn.innerText = fb.emoji;
            btn.title = fb.value;
            btn.onclick = () => {
                // Desabilita todos os bot√µes de feedback neste container
                container.querySelectorAll('.feedback-btn').forEach(b => b.disabled = true);
                label.innerText = 'Obrigado pelo feedback!';
                handleFeedback(userQuery, responsePayload, fb.value);
            };
            container.appendChild(btn);
        });

        chatHistory.appendChild(container);
        chatHistory.scrollTop = chatHistory.scrollHeight;
    }

    async function handleFeedback(userQuery, responsePayload, feedbackValue) {
        const logData = {
            query: userQuery,
            response: responsePayload.text,
            intentId: responsePayload.intentId,
            score: responsePayload.score,
            contextUsed: responsePayload.contextUsed,
            feedback: feedbackValue
        };
        // Envia o log para o backend para ser salvo no DB
        fetch('api/log-interaction.php', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(logData)
        });
    }

    async function handleUserMessage() {
        const userQuery = userInput.value.trim();
        if (!userQuery) return;

        // Adiciona msg do usu√°rio
        addMessage(userQuery, 'user');
        userInput.value = '';
        userInput.disabled = true;

        // Simula "pensando"
        typingIndicator.style.display = 'block';
        
        // Delay artificial para parecer natural (1s a 2s)
        const delay = Math.floor(Math.random() * 1000) + 800;
        
        setTimeout(async () => {
            const response = await findResponse(userQuery);
            typingIndicator.style.display = 'none';
            
            // Atualiza o contexto (remove tags HTML para n√£o sujar o embedding futuro)
            // Guarda a resposta do bot para ajudar na pr√≥xima interpreta√ß√£o
            lastBotContext = response.text.replace(/<[^>]*>?/gm, '').substring(0, 100);

            addMessage(response.text, 'bot');
            
            // Se houver op√ß√µes (bot√µes), renderiza
            if(response.options && response.options.length > 0) {
                addOptions(response.options);
            }

            addFeedbackControls(userQuery, response); // Adiciona bot√µes de feedback
            userInput.disabled = false;
            userInput.focus();
        }, delay);
    }
 
    // Eventos
    sendBtn.addEventListener('click', handleUserMessage);
    userInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') handleUserMessage();
    });

    // Iniciar
    initAI();

</script>

</body>
</html>
