 <!DOCTYPE html>
 <html lang="pt-BR">
 <head>
     <meta charset="UTF-8">
     <meta name="viewport" content="width=device-width, initial-scale=1.0">
     <title>Assistente Virtual v8 â€“ ESF Thamara</title>
     <link rel="stylesheet" href="./../public/css/xp-responsive.css">
     <style>
         /* Estilos do Chat v8 */
         .chat-wrapper { display: flex; flex-direction: column; height: 100%; }
         .chat-history { flex: 1; overflow-y: auto; padding: 20px; background: #fff; display: flex; flex-direction: column; gap: 12px; scroll-behavior: smooth; }
         .message { max-width: 85%; padding: 12px 16px; border-radius: 18px; font-size: 15px; line-height: 1.5; position: relative; animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
         .message.bot { align-self: flex-start; background: #f0f2f5; color: #1c1e21; border-bottom-left-radius: 4px; border: 1px solid #e4e6eb; }
         .message.user { align-self: flex-end; background: #0084ff; color: white; border-bottom-right-radius: 4px; }
         .chat-controls { padding: 15px; background: #f0f0f0; border-top: 1px solid #dcdcdc; display: flex; gap: 10px; align-items: center; }
         .chat-input { flex: 1; padding: 12px; border: 1px solid #ccc; border-radius: 24px; outline: none; font-size: 15px; transition: border-color 0.2s; }
         .chat-input:focus { border-color: #0084ff; box-shadow: 0 0 0 2px rgba(0,132,255,0.2); }
         .send-btn { background: #0084ff; color: white; border: none; padding: 10px 24px; border-radius: 24px; cursor: pointer; font-weight: 600; transition: background 0.2s; }
         .send-btn:hover { background: #0073e6; }
         .typing { font-size: 12px; color: #65676b; margin-left: 20px; margin-bottom: 5px; display: none; font-style: italic; }
         
         /* BotÃµes de OpÃ§Ã£o */
         .options-container { display: flex; flex-wrap: wrap; gap: 8px; margin: 8px 0 16px 20px; animation: popIn 0.3s ease; }
         .option-btn { background: #fff; border: 1px solid #0084ff; color: #0084ff; padding: 8px 16px; border-radius: 20px; cursor: pointer; font-size: 14px; transition: all 0.2s; }
         .option-btn:hover { background: #0084ff; color: #fff; transform: translateY(-1px); }
 
         /* Feedback */
         .feedback-container { display: flex; gap: 8px; margin: 12px 0 5px 20px; align-items: center; animation: popIn 0.4s ease; }
         .feedback-container span { font-size: 13px; color: #65676b; font-style: italic; }
         .feedback-btn { background: #f0f2f5; border: 1px solid #dcdcdc; border-radius: 50%; width: 34px; height: 34px; cursor: pointer; font-size: 16px; transition: all 0.2s; display: flex; align-items: center; justify-content: center; }
         .feedback-btn:hover:not(:disabled) { background: #e4e6eb; transform: scale(1.1); }
         .feedback-btn:disabled { cursor: not-allowed; filter: grayscale(80%); opacity: 0.7; }
 
         @keyframes popIn { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }
     </style>
 </head>
 <body> 
 
 <div class="xp-window" style="max-width: 800px; margin: 20px auto; height: 80vh; display: flex; flex-direction: column;">
     <div class="xp-titlebar">ðŸ¤– Assistente Virtual v8 (Neural)</div>
     <div class="xp-content" style="flex: 1; padding: 0; overflow: hidden;">
         
         <div class="chat-wrapper">
             <div id="chatHistory" class="chat-history">
                 <div class="message bot">
                     OlÃ¡! Sou a IA da ESF Thamara (v8.114.89). ðŸ§ <br>
                     Estou conectada ao banco de dados unificado.<br>
                     <strong>Como posso ajudar vocÃª hoje?</strong>
                 </div>
             </div>
             
             <div id="typingIndicator" class="typing">Processando...</div>
             
             <div class="chat-controls">
                 <input type="text" id="userInput" class="chat-input" placeholder="Digite sua dÃºvida..." autocomplete="off">
                 <button id="sendBtn" class="send-btn">Enviar</button>
             </div>
         </div>
 
     </div>
 </div>
 
 <script type="module">
     import { NeuralBrain } from './neural.js';
 
     const chatHistory = document.getElementById('chatHistory');
     const userInput = document.getElementById('userInput');
     const sendBtn = document.getElementById('sendBtn');
     const typingIndicator = document.getElementById('typingIndicator');
 
     // Inicializa o CÃ©rebro da IA
     const brain = new NeuralBrain();
     
     // Mensagem de carregamento
     addMessage("<i>ðŸ”„ Inicializando sistema neural... aguarde.</i>", 'bot');
     userInput.disabled = true;
 
     brain.initialize().then(success => {
         const loadingMsg = chatHistory.querySelector('.bot:last-child');
         if(loadingMsg && loadingMsg.innerHTML.includes('Inicializando')) loadingMsg.remove();
 
         if (success) {
             addMessage("âœ… Sistema pronto! Base de conhecimento carregada.", 'bot');
             userInput.disabled = false;
             userInput.focus();
         } else {
             addMessage("âŒ Erro ao conectar ao servidor. Tente recarregar.", 'bot');
         }
     });
 
     // FunÃ§Ãµes de UI
     function addMessage(text, sender) {
         const div = document.createElement('div');
         div.className = `message ${sender}`;
         div.innerHTML = text;
         chatHistory.appendChild(div);
         chatHistory.scrollTop = chatHistory.scrollHeight;
     }
 
     function addOptions(options) {
         const div = document.createElement('div');
         div.className = 'options-container';
         options.forEach(opt => {
             const btn = document.createElement('button');
             btn.className = 'option-btn';
             btn.innerText = opt;
             btn.onclick = () => { userInput.value = opt; handleUserMessage(); };
             div.appendChild(btn);
         });
         chatHistory.appendChild(div);
         chatHistory.scrollTop = chatHistory.scrollHeight;
     }
 
     function addFeedback(query, responseData) {
         const container = document.createElement('div');
         container.className = 'feedback-container';
         container.innerHTML = '<span>Ãštil?</span>';
         
         const emojis = [{e:'ðŸ‘',v:'positive'}, {e:'ðŸ˜',v:'neutral'}, {e:'ðŸ‘Ž',v:'negative'}];
         
         emojis.forEach(item => {
             const btn = document.createElement('button');
             btn.className = 'feedback-btn';
             btn.innerText = item.e;
             btn.onclick = () => {
                 container.querySelectorAll('button').forEach(b => b.disabled = true);
                 container.querySelector('span').innerText = 'Obrigado!';
                 
                 // Envia log para o backend via NeuralBrain
                 brain.sendFeedback({
                     query: query,
                     response: responseData.text,
                     intentId: responseData.intentId,
                     score: responseData.score,
                     contextUsed: responseData.contextUsed,
                     feedback: item.v
                 });
             };
             container.appendChild(btn);
         });
         chatHistory.appendChild(container);
         chatHistory.scrollTop = chatHistory.scrollHeight;
     }
 
     async function handleUserMessage() {
         const text = userInput.value.trim();
         if (!text) return;
 
         addMessage(text, 'user');
         userInput.value = '';
         userInput.disabled = true;
         typingIndicator.style.display = 'block';
 
         try {
            // Processamento Neural
            const response = await brain.processQuery(text);
            
            typingIndicator.style.display = 'none';
            addMessage(response.text, 'bot');
            
            if (response.options && response.options.length) addOptions(response.options);
            addFeedback(text, response);
        } catch (error) {
            console.error("Erro ao processar a mensagem:", error);
            addMessage("âŒ Desculpe, ocorreu um erro ao processar sua solicitaÃ§Ã£o. Tente novamente.", 'bot');
        } finally {
            typingIndicator.style.display = 'none';
            userInput.disabled = false;
            userInput.focus();
        }
     }
 
     sendBtn.addEventListener('click', handleUserMessage);
     userInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') handleUserMessage(); });
 </script>
 </body>
 </html>
