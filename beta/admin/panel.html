<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel Administrativo - ESF Thamara</title>
    <link rel="stylesheet" href="../../public/css/xp-responsive.css">
    <style>
        body { background-color: #ece9d8; padding: 20px; }
        .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; }
        .stat-card { background: #fff; padding: 15px; border: 1px solid #999; border-radius: 4px; }
        .stat-number { font-size: 2em; font-weight: bold; color: #0055ea; }
        table { width: 100%; border-collapse: collapse; font-size: 12px; }
        th, td { border: 1px solid #ccc; padding: 5px; text-align: left; }
        th { background: #f0f0f0; }
        .log-entry { font-family: monospace; }
    </style>
</head>
<body>
    <div class="xp-window">
        <div class="xp-titlebar">üõ°Ô∏è Painel de Controle - Acesso Restrito</div>
        <div class="xp-content">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <h1>Monitoramento de Sistema</h1>
                <button onclick="logout()">Sair</button>
            </div>

            <div class="dashboard-grid">
                <!-- Estat√≠sticas -->
                <div class="stat-card">
                    <h3>Total de Acessos</h3>
                    <div id="totalAccess" class="stat-number">Carregando...</div>
                </div>
                <div class="stat-card">
                    <h3>Visitantes √önicos (IPs)</h3>
                    <div id="uniqueIps" class="stat-number">Carregando...</div>
                </div>
            </div>

            <hr>

            <div class="dashboard-grid">
                <!-- Logs Recentes -->
                <div>
                    <h3>üìú √öltimos 50 Acessos</h3>
                    <div style="height: 300px; overflow-y: auto; background: #fff; border: 1px solid #ccc;">
                        <table id="logsTable">
                            <thead><tr><th>Data</th><th>IP</th><th>Rota</th></tr></thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>

                <!-- Controle de IPs -->
                <div>
                    <h3>üîí IPs de Administradores</h3>
                    <div style="margin-bottom: 10px;">
                        <input type="text" id="newIp" placeholder="IP (ex: 192.168.0.1)">
                        <input type="text" id="ipDesc" placeholder="Descri√ß√£o (ex: Casa Ivan)">
                        <button onclick="addIp()">Adicionar</button>
                    </div>
                    <ul id="ipList" style="background: #fff; border: 1px solid #ccc; height: 200px; overflow-y: auto; padding: 10px;"></ul>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_URL = '/api/admin';
        const token = localStorage.getItem('admin_token');

        if (!token) {
            window.location.href = '/index.html'; // Redireciona se n√£o estiver logado
        }

        async function fetchStats() {
            try {
                const res = await fetch(`${API_URL}/stats`, { headers: { 'Authorization': `Bearer ${token}` } });
                if(res.status === 401 || res.status === 403) logout();
                const data = await res.json();

                document.getElementById('totalAccess').innerText = data.total;
                document.getElementById('uniqueIps').innerText = data.unique;

                const tbody = document.querySelector('#logsTable tbody');
                tbody.innerHTML = '';
                data.logs.forEach(log => {
                    const row = `<tr>
                        <td>${new Date(log.timestamp).toLocaleString()}</td>
                        <td class="log-entry">${log.ip}</td>
                        <td class="log-entry">${log.method} ${log.path}</td>
                    </tr>`;
                    tbody.innerHTML += row;
                });
            } catch (e) { console.error(e); }
        }

        async function fetchIps() {
            const res = await fetch(`${API_URL}/ips`, { headers: { 'Authorization': `Bearer ${token}` } });
            const data = await res.json();
            const list = document.getElementById('ipList');
            list.innerHTML = '';
            data.forEach(item => {
                list.innerHTML += `<li><strong>${item.ip}</strong> - ${item.description}</li>`;
            });
        }

        async function addIp() {
            const ip = document.getElementById('newIp').value;
            const description = document.getElementById('ipDesc').value;
            if(!ip) return alert('Digite um IP');

            await fetch(`${API_URL}/ips`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                body: JSON.stringify({ ip, description })
            });
            document.getElementById('newIp').value = '';
            fetchIps();
        }

        function logout() {
            localStorage.removeItem('admin_token');
            window.location.href = '/index.html';
        }

        // Iniciar
        fetchStats();
        fetchIps();
        // Atualizar a cada 30s
        setInterval(fetchStats, 30000);
    </script>
</body>
</html>